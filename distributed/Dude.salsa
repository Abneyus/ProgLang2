module distributed;

import java.io.*;
import java.util.*;

behavior Dude{
  int id;
  String host;
  int port;
  int priority;
  int tolerance;
  int actors;

  boolean active;
  boolean pastLeader;

  Dude left;

  Dude(int id, String host, int port, int priority, int tolerance, int actors, Dude left) {
    this.id = id;
    this.host = host;
    this.port = port;
    this.priority = priority;
    this.tolerance = tolerance;
    this.actors = actors;

    this.active = false;
    this.pastLeader = false;

    this.left = left;
  }

  void consider(int candidate, int canditatePriority, int timestamp, int elections)
  {
    if(elections == actors)
    {
      writeMessage("End of simulation");
    }
    else if(candidate == this.id)
    {
      active = true;
      pastLeader = true;
      writeMessage("ID=" + this.id + " became leader at t=" + timestamp + "\n");
      tick(timestamp, timestamp, this.id, 0, elections);
    }
    else
    {
      if(canditatePriority > this.priority)
      {
        this.left <- consider(candidate, canditatePriority, timestamp, elections);
      }
      else if(!pastLeader)
      {
        this.left <- consider(this.id, this.priority, timestamp, elections);
      }
      else
      {
        this.left <- consider(candidate, canditatePriority, timestamp, elections);
      }
    }
  }

  void tick(int timestamp, int electionTime, int presidentID, int revolts, int elections)
  {
    if(presidentID == this.id)
    {
      if(revolts > ((actors-1)/2))
      {
        writeMessage("ID=" + this.id + " was deposed at t=" + timestamp + "\n");
        active = false;
        consider(-1, -1, timestamp+1, elections+1);
      }
      else
      {
        left <- tick(timestamp+1, electionTime, presidentID, revolts, elections);
      }
    }
    else if(timestamp - electionTime > tolerance && timestamp - electionTime - actors < tolerance)
    {
      writeMessage("ID=" + this.id + " revolted at t=" + timestamp + "\n");
      left <- tick(timestamp+1, electionTime, presidentID, revolts+1, elections);
    }
    else
    {
      left <- tick(timestamp+1, electionTime, presidentID, revolts, elections);
    }
  }

  void writeMessage(String  temp)
  {
    try
    {
      FileWriter fw = new FileWriter("output.txt", true);
      BufferedWriter bw = new BufferedWriter(fw);
      bw.write(temp);
      bw.close();
      fw.close();
    } catch (IOException e)
    {
      return;
    }
  }

  void setLeft(Dude left)
  {
    this.left = left;
  }

}
